name: Frontend

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./front

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install test reporters
      run: npm install -D karma-junit-reporter

    - name: Update karma config
      run: |
        # CrÃ©er un fichier temporaire avec la nouvelle configuration
        cat > karma.conf.js.new << 'EOL'
        module.exports = function (config) {
          config.set({
            basePath: '',
            frameworks: ['jasmine', '@angular-devkit/build-angular'],
            plugins: [
              require('karma-jasmine'),
              require('karma-chrome-launcher'),
              require('karma-jasmine-html-reporter'),
              require('karma-coverage'),
              require('karma-junit-reporter'),
              require('@angular-devkit/build-angular/plugins/karma')
            ],
            client: {
              jasmine: {},
              clearContext: false
            },
            reporters: ['progress', 'junit'],
            junitReporter: {
              outputDir: 'test-results',
              outputFile: 'junit.xml'
            },
            coverageReporter: {
              dir: require('path').join(__dirname, './coverage/bobapp'),
              subdir: '.',
              reporters: [
                { type: 'html' },
                { type: 'text-summary' }
              ]
            },
            port: 9876,
            colors: true,
            logLevel: config.LOG_INFO,
            autoWatch: true,
            browsers: ['Chrome'],
            singleRun: false,
            restartOnFileChange: true
          });
        };
        EOL
        # Remplacer l'ancien fichier par le nouveau
        mv karma.conf.js.new karma.conf.js

    - name: Run tests with coverage
      run: |
        CHROME_BIN=/usr/bin/google-chrome
        mkdir -p test-results
        npm run test -- --no-watch --code-coverage --browsers=ChromeHeadless

    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v4
      if: always()
      with:
        report_paths: 'test-results/junit.xml'
        detailed_summary: true
        include_passed: true
      
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage-reports
        path: front/coverage/
        retention-days: 7
